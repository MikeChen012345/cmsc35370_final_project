name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  python-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python 3.11
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    # - name: Run code style checks
    #   run: |
    #     flake8 .
    #     black --check .
    # - name: Run tests
    #   run: |
    #     pytest


  deploy:
    runs-on: ubuntu-latest
    environment: aws
    steps:
    - uses: actions/checkout@v2

    - name: Prepare EC2 SSH key
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > github-ec2.pem
        chmod 600 github-ec2.pem

    - name: Deploy to EC2 (single SSH session)
      env:
        HOST: ${{ secrets.EC2_HOST }}
        SSH_USER: ${{ secrets.EC2_USER }}
      run: |
        ssh -o StrictHostKeyChecking=no -i github-ec2.pem ${SSH_USER}@${HOST} << 'EOF'
        set -e
        echo "Connected to EC2 instance"

        REPO_NAME="cmsc35370_final_project"
        REPO_URL="https://github.com/MikeChen012345/$REPO_NAME.git"
        BRANCH="main"
        REPO_DIR="$HOME/$REPO_NAME"

        if [ -d "$REPO_DIR/.git" ]; then
          cd "$REPO_DIR"
          git fetch origin "$BRANCH"
          git reset --hard origin/"$BRANCH"
        else
          git clone --branch "$BRANCH" "$REPO_URL" "$REPO_DIR"
          cd "$REPO_DIR"
        fi
        echo "Repository update complete"

        # Ensure python3 exists; install with the instance package manager if missing
        if command -v python3 >/dev/null 2>&1; then
          echo "python3 found: $(python3 --version)"
        else
          echo "python3 not found — attempting to install"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y python3 python3-venv python3-pip
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y python3 python3-pip
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y python3 python3-pip
          else
            echo "No supported package manager (apt/yum/dnf) found; cannot install python3" >&2
            exit 1
          fi
        fi

        # Ensure pip3 is available (try package manager first, otherwise use python -m pip)
        if command -v pip3 >/dev/null 2>&1; then
          echo "pip3 found: $(pip3 --version)"
        else
          echo "pip3 not found — attempting to install"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y python3-pip
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y python3-pip || true
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y python3-pip || true
          fi
          # final fallback: try ensurepip / pip bootstrap
          if command -v pip3 >/dev/null 2>&1; then
            echo "pip3 installed successfully"
          else
            if command -v python3 >/dev/null 2>&1; then
              python3 -m ensurepip --upgrade 2>/dev/null || true
              python3 -m pip install --upgrade pip setuptools wheel || true
            fi
          fi
        fi

        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt

        echo "Dependency installation complete"

        FASTAPI_PY="fastapi:app"
        pkill -f "uvicorn $FASTAPI_PY" || true
        nohup uvicorn $FASTAPI_PY --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
        echo "Application restart complete"
        EOF
