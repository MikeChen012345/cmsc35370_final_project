name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  python-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python 3.11
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    # - name: Run code style checks
    #   run: |
    #     flake8 .
    #     black --check .
    # - name: Run tests
    #   run: |
    #     pytest


  deploy:
    runs-on: ubuntu-latest
    environment: aws
    steps:
    - uses: actions/checkout@v2

    - name: Prepare EC2 SSH key
      run: |
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > github-ec2.pem
        chmod 600 github-ec2.pem

    - name: Deploy to EC2 (single SSH session)
      env:
        HOST: ${{ secrets.EC2_HOST }}
        SSH_USER: ${{ secrets.EC2_USER }}
      run: |
        ssh -o StrictHostKeyChecking=no -i github-ec2.pem ${SSH_USER}@${HOST} << 'EOF'
        set -e
        echo "Connected to EC2 instance"

        REPO_NAME="cmsc35370_final_project"
        REPO_URL="https://github.com/MikeChen012345/$REPO_NAME.git"
        BRANCH="main"
        REPO_DIR="$HOME/$REPO_NAME"

        if [ -d "$REPO_DIR/.git" ]; then
          cd "$REPO_DIR"
          git fetch origin "$BRANCH"
          git reset --hard origin/"$BRANCH"
        else
          git clone --branch "$BRANCH" "$REPO_URL" "$REPO_DIR"
          cd "$REPO_DIR"
        fi
        echo "Repository update complete"

        # Ensure python3 exists; install with the instance package manager if missing
        if command -v python3 >/dev/null 2>&1; then
          echo "python3 found: $(python3 --version)"
        else
          echo "python3 not found — attempting to install"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y python3 python3-venv python3-pip
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y python3 python3-pip
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y python3 python3-pip
          else
            echo "No supported package manager (apt/yum/dnf) found; cannot install python3" >&2
            exit 1
          fi
        fi

        # Ensure pip3 is available (try package manager first, otherwise use python -m pip)
        if command -v pip3 >/dev/null 2>&1; then
          echo "pip3 found: $(pip3 --version)"
        else
          echo "pip3 not found — attempting to install"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y python3-pip
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y python3-pip || true
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y python3-pip || true
          fi
          # final fallback: try ensurepip / pip bootstrap
          if command -v pip3 >/dev/null 2>&1; then
            echo "pip3 installed successfully"
          else
            if command -v python3 >/dev/null 2>&1; then
              python3 -m ensurepip --upgrade 2>/dev/null || true
              python3 -m pip install --upgrade pip setuptools wheel || true
            fi
          fi
        fi

        # Ensure python-venv is available
        if python3 -m venv --help >/dev/null 2>&1; then
          echo "python3-venv module is available"
        else
          echo "python3-venv module not found — attempting to install"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y python3-venv
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y python3-venv || true
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y python3-venv || true
          fi
        fi
        echo "Python environment setup complete"
        
        # Start a virtual environment (create and handle ensurepip missing)
        if [ -d "venv" ]; then
          echo "Using existing virtual environment"
        else
          echo "Creating new virtual environment"
          # try to create venv, capture stderr for diagnostics
          if python3 -m venv venv 2>/tmp/venv-create.err; then
            echo "Virtual environment created successfully"
          else
            echo "Failed to create virtual environment. Checking ensurepip..."
            # check for ensurepip
            if python3 -c "import ensurepip" >/dev/null 2>&1; then
              echo "ensurepip is present but venv creation failed. See /tmp/venv-create.err for details."
            else
              echo "ensurepip module not available."
              echo "On Debian/Ubuntu you may need to install the python3 venv package (example: python3.12-venv)."
              echo "Attempting to install python3.12-venv and python3-venv with sudo..."
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update
                sudo apt-get install -y python3.12-venv python3-venv || true
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y python3-venv || true
              elif command -v dnf >/dev/null 2>&1; then
                sudo dnf install -y python3-venv || true
              fi
            fi

            # try again after possible install
            if python3 -m venv venv 2>/tmp/venv-create2.err; then
              echo "Virtual environment created after installing venv package"
            else
              echo "Virtual environment still failed to create."
              echo "--- venv-create.err ---"
              sed -n '1,200p' /tmp/venv-create.err || true
              echo "--- venv-create2.err ---"
              sed -n '1,200p' /tmp/venv-create2.err || true
              echo ""
              echo "If ensurepip was missing on Debian/Ubuntu, install the venv package manually, for example:"
              echo "  sudo apt install python3.12-venv"
              echo "Then recreate the virtual environment on the instance:"
              echo "  python3 -m venv venv"
              exit 1
            fi
          fi
        fi
        source venv/bin/activate
        echo "Virtual environment setup complete"

        # Start a virtual environment
        if [ -d "venv" ]; then
          echo "Using existing virtual environment"
        else
          echo "Creating new virtual environment"
          python3 -m venv venv
        fi
        source venv/bin/activate
        echo "Virtual environment setup complete"

        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt

        echo "Dependency installation complete"

        FASTAPI_MODULE="fastapi_main:app"
        FASTAPI_LOG="uvicorn.log"
        FASTAPI_PORT=80
        sudo pkill -f $FASTAPI_MODULE || true
        nohup sudo venv/bin/python -m uvicorn $FASTAPI_MODULE --host 0.0.0.0 --port $FASTAPI_PORT > $FASTAPI_LOG 2>&1 &
        echo "Application restart complete"

        EOF
